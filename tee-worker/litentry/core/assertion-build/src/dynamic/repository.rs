// Copyright 2020-2024 Trust Computing GmbH.
// This file is part of Litentry.
//
// Litentry is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Litentry is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Litentry.  If not, see <https://www.gnu.org/licenses/>.

#[cfg(all(feature = "std", feature = "sgx"))]
compile_error!("feature \"std\" and feature \"sgx\" cannot be enabled at the same time");

#[cfg(all(not(feature = "std"), feature = "sgx"))]
extern crate sgx_tstd as std;

use lc_dynamic_assertion::AssertionLogicRepository;
use primitive_types::H160;
use std::{
	collections::HashMap,
	string::{String, ToString},
	vec,
	vec::Vec,
};

pub type SmartContractByteCode = Vec<u8>;

#[cfg(feature = "sgx")]
use std::sync::SgxMutex as Mutex;

#[cfg(feature = "std")]
use std::sync::Mutex;

#[allow(clippy::type_complexity)]
pub struct InMemorySmartContractRepo {
	map: Mutex<HashMap<H160, (Vec<u8>, Vec<String>)>>,
}

impl InMemorySmartContractRepo {
	pub fn new() -> Self {
		let mut map = HashMap::new();
		//a1
		map.insert(
            hash(0),
			(
				hex::decode("608060405234801561001057600080fd5b50610af2806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063e256184614610030575b600080fd5b61004361003e366004610661565b61005d565b60405161005495949392919061085f565b60405180910390f35b60608060608060008060405180608001604052806045815260200161098460459139604080518082018252601b81527f4261736963204964656e7469747920566572696669636174696f6e000000000060208083019190915260008054600181018255818052845160c08101909552608180865295965092947f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56390930193909290916109c990830139805161011993925060209091019061041e565b506040518060a0016040528060738152602001610a4a6073913980516101479160019160209091019061041e565b5060008080805b8c518110156101c5576101798d828151811061016c5761016c610909565b6020026020010151610351565b1561018757600191506101b3565b6101a98d828151811061019c5761019c610909565b6020026020010151610380565b156101b357600192505b806101bd8161091f565b91505061014e565b508080156101d05750815b92508484600060018682805480602002602001604051908101604052809291908181526020016000905b828210156102a657838290600052602060002001805461021990610948565b80601f016020809104026020016040519081016040528092919081815260200182805461024590610948565b80156102925780601f1061026757610100808354040283529160200191610292565b820191906000526020600020905b81548152906001019060200180831161027557829003601f168201915b5050505050815260200190600101906101fa565b5050505092508180546102b890610948565b80601f01602080910402602001604051908101604052809291908181526020018280546102e490610948565b80156103315780601f1061030657610100808354040283529160200191610331565b820191906000526020600020905b81548152906001019060200180831161031457829003601f168201915b505050505091509950995099509950995050505050509295509295909350565b600061035c826103a9565b8061036b575061036b826103b6565b8061037a575061037a826103c3565b92915050565b600061038b826103d0565b8061039a575061039a826103dd565b8061037a575061037a826103ea565b600061037a8260006103f3565b600061037a8260016103f3565b600061037a8260026103f3565b600061037a8260036103f3565b600061037a8260046103f3565b600061037a8260055b60008163ffffffff16836000015163ffffffff1614156104155750600161037a565b50600092915050565b82805461042a90610948565b90600052602060002090601f01602090048101928261044c5760008555610492565b82601f1061046557805160ff1916838001178555610492565b82800160010185558215610492579182015b82811115610492578251825591602001919060010190610477565b5061049e9291506104a2565b5090565b5b8082111561049e57600081556001016104a3565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff811182821017156104f0576104f06104b7565b60405290565b604051601f8201601f1916810167ffffffffffffffff8111828210171561051f5761051f6104b7565b604052919050565b600067ffffffffffffffff821115610541576105416104b7565b5060051b60200190565b803563ffffffff8116811461055f57600080fd5b919050565b600067ffffffffffffffff83111561057e5761057e6104b7565b610591601f8401601f19166020016104f6565b90508281528383830111156105a557600080fd5b828260208301376000602084830101529392505050565b600082601f8301126105cd57600080fd5b813560206105e26105dd83610527565b6104f6565b82815260059290921b8401810191818101908684111561060157600080fd5b8286015b8481101561065657803567ffffffffffffffff8111156106255760008081fd5b8701603f810189136106375760008081fd5b610648898683013560408401610564565b845250918301918301610605565b509695505050505050565b6000806040838503121561067457600080fd5b823567ffffffffffffffff8082111561068c57600080fd5b818501915085601f8301126106a057600080fd5b813560206106b06105dd83610527565b82815260059290921b840181019181810190898411156106cf57600080fd5b8286015b848110156107e2578035868111156106ea57600080fd5b87016060818d03601f1901121561070057600080fd5b6107086104cd565b61071386830161054b565b815260408201358881111561072757600080fd5b8201603f81018e1361073857600080fd5b6107498e8883013560408401610564565b878301525060608201358881111561076057600080fd5b8083019250508c603f83011261077557600080fd5b858201356107856105dd82610527565b81815260059190911b83018701870190878101908f8311156107a657600080fd5b6040850194505b828510156107cd576107be8561054b565b825293880193908801906107ad565b604084015250508452509183019183016106d3565b50965050860135925050808211156107f957600080fd5b50610806858286016105bc565b9150509250929050565b60008151808452602060005b8281101561083757848101820151868201830152810161081c565b828111156108485760008284880101525b5080601f19601f8401168601019250505092915050565b60a08152600061087260a0830188610810565b6020838203818501526108858289610810565b915083820360408501528187518084528284019150828160051b850101838a0160005b838110156108d657601f198784030185526108c4838351610810565b948601949250908501906001016108a8565b505086810360608801526108ea818a610810565b955050505050506108ff608083018415159052565b9695505050505050565b634e487b7160e01b600052603260045260246000fd5b600060001982141561094157634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c9082168061095c57607f821691505b6020821081141561097d57634e487b7160e01b600052602260045260246000fd5b5091905056fe596f75277665206964656e746966696564206174206c65617374206f6e65206163636f756e742f6164647265737320696e20626f7468205765623220616e6420576562332e7b22616e64223a205b7b2022737263223a2022246861735f776562325f6163636f756e74222c20226f70223a20223d3d222c2022647374223a20227472756522207d2c207b2022737263223a2022246861735f776562335f6163636f756e74222c20226f70223a20223d3d222c2022647374223a20227472756522207d205d207d68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f312d62617369632d6964656e746974792d766572696669636174696f6e2f312d302d302e6a736f6ea26469706673582212201c295fa832769ae2bab11a8c0dc35724f60650f2710135a9453d55ffe206b1e664736f6c634300080b0033").unwrap(),
				vec![]
				)
        );
		//a20
		map.insert(
			hash(1),
			(
				hex::decode("608060405234801561001057600080fd5b50610d41806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063e256184614610030575b600080fd5b61004361003e366004610777565b61005d565b604051610054959493929190610981565b60405180910390f35b6060806060806000806040518060c0016040528060868152602001610c0f60869139604080518082018252601c81527f49444875622045564d2056657273696f6e204561726c7920426972640000000060208083019190915260008054600181018255818052845160608101909552603380865295965092947f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639093019390929091610c95908301398051610119939250602090910190610534565b506040518060a0016040528060758152602001610b9a60759139805161014791600191602090910190610534565b506000805b8a51811015610263576101778b828151811061016a5761016a610a2b565b60200260200101516103e1565b156102515760006101a48c838151811061019357610193610a2b565b602002602001015160200151610410565b905060006101ca604051806080016040528060448152602001610cc8604491398361045b565b604080518082018252600a8152690bda185cd29bda5b995960b21b6020808301919091528251600080825291810190935292935091908161022d565b60408051808201909152606080825260208201528152602001906001900390816102065790505b50905061023b83838361048a565b9550851561024c5750505050610263565b505050505b8061025b81610a41565b91505061014c565b508282600060018482805480602002602001604051908101604052809291908181526020016000905b828210156103385783829060005260206000200180546102ab90610a6a565b80601f01602080910402602001604051908101604052809291908181526020018280546102d790610a6a565b80156103245780601f106102f957610100808354040283529160200191610324565b820191906000526020600020905b81548152906001019060200180831161030757829003601f168201915b50505050508152602001906001019061028c565b50505050925081805461034a90610a6a565b80601f016020809104026020016040519081016040528092919081815260200182805461037690610a6a565b80156103c35780601f10610398576101008083540402835291602001916103c3565b820191906000526020600020905b8154815290600101906020018083116103a657829003601f168201915b50505050509150975097509750975097505050509295509295909350565b60006103ec826104e7565b806103fb57506103fb826104f4565b8061040a575061040a82610501565b92915050565b60606000826040516020016104259190610aa5565b60408051601f1981840301815291905280519091506082838260208501600061041b600019f161045457600080fd5b5050919050565b606060008383604051602001610472929190610abf565b60408051808303601f19018152919052949350505050565b60008060008585856040516020016104a493929190610aee565b60408051601f19818403018152908290528051909250906020818382860160006103e9600019f16104d457600080fd5b6020810160405251979650505050505050565b600061040a82600361050a565b600061040a82600461050a565b600061040a8260055b60008163ffffffff16836000015163ffffffff16141561052c5750600161040a565b50600061040a565b82805461054090610a6a565b90600052602060002090601f01602090048101928261056257600085556105a8565b82601f1061057b57805160ff19168380011785556105a8565b828001600101855582156105a8579182015b828111156105a857825182559160200191906001019061058d565b506105b49291506105b8565b5090565b5b808211156105b457600081556001016105b9565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff81118282101715610606576106066105cd565b60405290565b604051601f8201601f1916810167ffffffffffffffff81118282101715610635576106356105cd565b604052919050565b600067ffffffffffffffff821115610657576106576105cd565b5060051b60200190565b803563ffffffff8116811461067557600080fd5b919050565b600067ffffffffffffffff831115610694576106946105cd565b6106a7601f8401601f191660200161060c565b90508281528383830111156106bb57600080fd5b828260208301376000602084830101529392505050565b600082601f8301126106e357600080fd5b813560206106f86106f38361063d565b61060c565b82815260059290921b8401810191818101908684111561071757600080fd5b8286015b8481101561076c57803567ffffffffffffffff81111561073b5760008081fd5b8701603f8101891361074d5760008081fd5b61075e89868301356040840161067a565b84525091830191830161071b565b509695505050505050565b6000806040838503121561078a57600080fd5b823567ffffffffffffffff808211156107a257600080fd5b818501915085601f8301126107b657600080fd5b813560206107c66106f38361063d565b82815260059290921b840181019181810190898411156107e557600080fd5b8286015b848110156108f75780358681111561080057600080fd5b87016060818d03601f1901121561081657600080fd5b61081e6105e3565b610829868301610661565b815260408201358881111561083d57600080fd5b8201603f81018e1361084e57600080fd5b61085f8e888301356040840161067a565b878301525060608201358881111561087657600080fd5b8083019250508c603f83011261088b57600080fd5b8582013561089b6106f38261063d565b81815260059190911b830160400190878101908f8311156108bb57600080fd5b6040850194505b828510156108e2576108d385610661565b825293880193908801906108c2565b604084015250508452509183019183016107e9565b509650508601359250508082111561090e57600080fd5b5061091b858286016106d2565b9150509250929050565b60005b83811015610940578181015183820152602001610928565b8381111561094f576000848401525b50505050565b6000815180845261096d816020860160208601610925565b601f01601f19169290920160200192915050565b60a08152600061099460a0830188610955565b6020838203818501526109a78289610955565b915083820360408501528187518084528284019150828160051b850101838a0160005b838110156109f857601f198784030185526109e6838351610955565b948601949250908501906001016109ca565b50508681036060880152610a0c818a610955565b95505050505050610a21608083018415159052565b9695505050505050565b634e487b7160e01b600052603260045260246000fd5b6000600019821415610a6357634e487b7160e01b600052601160045260246000fd5b5060010190565b600181811c90821680610a7e57607f821691505b60208210811415610a9f57634e487b7160e01b600052602260045260246000fd5b50919050565b602081526000610ab86020830184610955565b9392505050565b60008351610ad1818460208801610925565b835190830190610ae5818360208801610925565b01949350505050565b606081526000610b016060830186610955565b602083820381850152610b148287610955565b91506040848303818601528286518085528385019150838160051b86010184890160005b83811015610b8857878303601f1901855281518051878552610b5c88860182610955565b91890151858303868b0152919050610b748183610955565b968901969450505090860190600101610b38565b50909b9a505050505050505050505056fe68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f31322d69646875622d65766d2d76657273696f6e2d6561726c792d626972642f312d302d302e6a736f6e546865207573657220697320616e206561726c7920626972642075736572206f6620746865204964656e746974794875622045564d2076657273696f6e20616e64206861732067656e657261746564206174206c6561737420312063726564656e7469616c20647572696e672032303233204175672031347468207e2041756720323173742e7b2022737263223a2022246861735f6a6f696e6564222c20226f70223a20223d3d222c2022647374223a20227472756522207d687474703a2f2f6c6f63616c686f73743a31393532372f6576656e74732f646f65732d757365722d6a6f696e65642d65766d2d63616d706169676e3f6163636f756e743da26469706673582212206f2898c546b7b586d3e8172e5f011fc6d1d1f39f955ea5da2b58f62d9a332e2264736f6c634300080b0033").unwrap(),
				vec![]
				)
		);
		//a6
		map.insert(
			hash(2),
			(
				hex::decode("608060405234801561001057600080fd5b506110ed806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063e256184614610030575b600080fd5b61004361003e366004610af6565b61005d565b604051610054959493929190610d00565b60405180910390f35b6060806060806000806040518060600160405280602e815260200161108a602e9139905060006040518060400160405280601781526020017f5477697474657220466f6c6c6f77657220416d6f756e7400000000000000000081525090506040518060a0016040528060738152602001610fde6073913980516100e8916001916020909101906108bc565b50600080805b8b518110156102a2576101198c828151811061010c5761010c610daa565b60200260200101516105f5565b1561029057600061015f6040518060600160405280602b8152602001610fb3602b91398e848151811061014e5761014e610daa565b602002602001015160200151610608565b905060006101a2826040518060400160405280601b81526020017f3f757365722e6669656c64733d7075626c69635f6d6574726963730000000000815250610608565b60408051600180825281830190925291925060009190816020015b60408051808201909152606080825260208201528152602001906001900390816101bd57905050905060405180604001604052806040518060400160405280600d81526020016c30baba3437b934bd30ba34b7b760991b81525081526020018f60008151811061022f5761022f610daa565b60200260200101518152508160008151811061024d5761024d610daa565b6020026020010181905250600061027d83604051806060016040528060248152602001610f586024913984610637565b90506102898187610dd6565b9550505050505b8061029a81610e27565b9150506100ee565b5060008060008360070b121580156102be575060018360070b13155b156102cf575060009050600161039a565b60018360070b1380156102e6575060648360070b13155b156102f7575060019050606461039a565b60648360070b13801561030f57506103e88360070b13155b156103215750606490506103e861039a565b6103e88360070b13801561033a57506127108360070b13155b1561034d57506103e8905061271061039a565b6127108360070b1380156103675750620186a08360070b13155b1561037b57506127109050620186a061039a565b620186a08360070b131561039a5750620186a09050677fffffffffffffff5b6001935060006103cd604051806060016040528060398152602001611051603991396103c88560070b610694565b610608565b90506103f181604051806060016040528060378152602001610f7c60379139610608565b9050610403816103c88460070b610694565b905061042e816040518060400160405280600781526020016622207d205d207d60c81b815250610608565b600080546001810182559080528151919250610473917f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5639091019060208401906108bc565b508686600060018882805480602002602001604051908101604052809291908181526020016000905b828210156105485783829060005260206000200180546104bb90610e42565b80601f01602080910402602001604051908101604052809291908181526020018280546104e790610e42565b80156105345780601f1061050957610100808354040283529160200191610534565b820191906000526020600020905b81548152906001019060200180831161051757829003601f168201915b50505050508152602001906001019061049c565b50505050925081805461055a90610e42565b80601f016020809104026020016040519081016040528092919081815260200182805461058690610e42565b80156105d35780601f106105a8576101008083540402835291602001916105d3565b820191906000526020600020905b8154815290600101906020018083116105b657829003601f168201915b505050505091509b509b509b509b509b50505050505050509295509295909350565b6000610602826000610706565b92915050565b60606000838360405160200161061f929190610e7d565b60408051808303601f19018152919052949350505050565b600080600085858560405160200161065193929190610eac565b60408051601f19818403018152908290528051909250906020818382860160006103e8600019f161068157600080fd5b6020810160405251979650505050505050565b6060600082126106b357604051806020016040528060008152506106ce565b604051806040016040528060018152602001602d60f81b8152505b6106df6106da84610730565b610747565b6040516020016106f0929190610e7d565b6040516020818303038152906040529050919050565b60008163ffffffff16836000015163ffffffff16141561072857506001610602565b506000610602565b6000808212156107435781600003610602565b5090565b60606000610754836107e4565b600101905060008167ffffffffffffffff8111156107745761077461094c565b6040519080825280601f01601f19166020018201604052801561079e576020820181803683370190505b5090508181016020015b600019016f181899199a1a9b1b9c1cb0b131b232b360811b600a86061a8153600a85049450846107d7576107dc565b6107a8565b509392505050565b60008072184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b83106108235772184f03e93ff9f4daa797ed6e38ed64bf6a1f0160401b830492506040015b6d04ee2d6d415b85acef8100000000831061084f576d04ee2d6d415b85acef8100000000830492506020015b662386f26fc10000831061086d57662386f26fc10000830492506010015b6305f5e1008310610885576305f5e100830492506008015b612710831061089957612710830492506004015b606483106108ab576064830492506002015b600a83106106025760010192915050565b8280546108c890610e42565b90600052602060002090601f0160209004810192826108ea5760008555610930565b82601f1061090357805160ff1916838001178555610930565b82800160010185558215610930579182015b82811115610930578251825591602001919060010190610915565b506107439291505b808211156107435760008155600101610938565b634e487b7160e01b600052604160045260246000fd5b6040516060810167ffffffffffffffff811182821017156109855761098561094c565b60405290565b604051601f8201601f1916810167ffffffffffffffff811182821017156109b4576109b461094c565b604052919050565b600067ffffffffffffffff8211156109d6576109d661094c565b5060051b60200190565b803563ffffffff811681146109f457600080fd5b919050565b600067ffffffffffffffff831115610a1357610a1361094c565b610a26601f8401601f191660200161098b565b9050828152838383011115610a3a57600080fd5b828260208301376000602084830101529392505050565b600082601f830112610a6257600080fd5b81356020610a77610a72836109bc565b61098b565b82815260059290921b84018101918181019086841115610a9657600080fd5b8286015b84811015610aeb57803567ffffffffffffffff811115610aba5760008081fd5b8701603f81018913610acc5760008081fd5b610add8986830135604084016109f9565b845250918301918301610a9a565b509695505050505050565b60008060408385031215610b0957600080fd5b823567ffffffffffffffff80821115610b2157600080fd5b818501915085601f830112610b3557600080fd5b81356020610b45610a72836109bc565b82815260059290921b84018101918181019089841115610b6457600080fd5b8286015b84811015610c7657803586811115610b7f57600080fd5b87016060818d03601f19011215610b9557600080fd5b610b9d610962565b610ba88683016109e0565b8152604082013588811115610bbc57600080fd5b8201603f81018e13610bcd57600080fd5b610bde8e88830135604084016109f9565b8783015250606082013588811115610bf557600080fd5b8083019250508c603f830112610c0a57600080fd5b85820135610c1a610a72826109bc565b81815260059190911b830160400190878101908f831115610c3a57600080fd5b6040850194505b82851015610c6157610c52856109e0565b82529388019390880190610c41565b60408401525050845250918301918301610b68565b5096505086013592505080821115610c8d57600080fd5b50610c9a85828601610a51565b9150509250929050565b60005b83811015610cbf578181015183820152602001610ca7565b83811115610cce576000848401525b50505050565b60008151808452610cec816020860160208601610ca4565b601f01601f19169290920160200192915050565b60a081526000610d1360a0830188610cd4565b602083820381850152610d268289610cd4565b915083820360408501528187518084528284019150828160051b850101838a0160005b83811015610d7757601f19878403018552610d65838351610cd4565b94860194925090850190600101610d49565b50508681036060880152610d8b818a610cd4565b95505050505050610da0608083018415159052565b9695505050505050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052601160045260246000fd5b60008160070b8360070b6000821282677fffffffffffffff03821381151615610e0157610e01610dc0565b82677fffffffffffffff19038212811615610e1e57610e1e610dc0565b50019392505050565b6000600019821415610e3b57610e3b610dc0565b5060010190565b600181811c90821680610e5657607f821691505b60208210811415610e7757634e487b7160e01b600052602260045260246000fd5b50919050565b60008351610e8f818460208801610ca4565b835190830190610ea3818360208801610ca4565b01949350505050565b606081526000610ebf6060830186610cd4565b602083820381850152610ed28287610cd4565b91506040848303818601528286518085528385019150838160051b86010184890160005b83811015610f4657878303601f1901855281518051878552610f1a88860182610cd4565b91890151858303868b0152919050610f328183610cd4565b968901969450505090860190600101610ef6565b50909b9a505050505050505050505056fe2f646174612f7075626c69635f6d6574726963732f666f6c6c6f776572735f636f756e7422207d2c207b2022737263223a2022246861735f776562335f6163636f756e74222c20226f70223a20223c3d222c2022647374223a2022687474703a2f2f6c6f63616c686f73743a31393532382f322f75736572732f62792f757365726e616d652f68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f6c6974656e7472792f76632d6a736f6e736368656d612f6d61696e2f646973742f736368656d61732f312d62617369632d6964656e746974792d766572696669636174696f6e2f312d302d302e6a736f6e7b22616e64223a205b7b2022737263223a202224746f74616c5f666f6c6c6f77657273222c20226f70223a20223e222c2022647374223a20225468652072616e6765206f662074686520757365722773205477697474657220666f6c6c6f77657220636f756e74a26469706673582212205477d94cb65333aa196b3b3039e3869eddc3644cc3d257895803d4f6809bbac264736f6c634300080b0033").unwrap(),
				vec!["twitter_api_key".to_string()]
				)
		);
		InMemorySmartContractRepo { map: map.into() }
	}
}

impl Default for InMemorySmartContractRepo {
	fn default() -> Self {
		Self::new()
	}
}

impl AssertionLogicRepository for InMemorySmartContractRepo {
	type Id = H160;
	type Item = (Vec<u8>, Vec<String>);

	fn get(&self, id: &H160) -> Result<Option<Self::Item>, String> {
		Ok(self.map.lock().unwrap().get(id).cloned())
	}

	fn save(&self, id: Self::Id, item: Self::Item) -> Result<(), String> {
		self.map.lock().unwrap().insert(id, item);
		Ok(())
	}
}

fn hash(a: u64) -> H160 {
	H160::from_low_u64_be(a)
}
